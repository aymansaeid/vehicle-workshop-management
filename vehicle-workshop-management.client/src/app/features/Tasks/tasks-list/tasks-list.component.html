<div class="view-wrapper">
  <dx-data-grid [dataSource]="dataSource"
                [allowColumnResizing]="true"
                [columnAutoWidth]="true"
                [showBorders]="true"
                [focusedRowEnabled]="true"
                [selection]="{ mode: 'single' }"
                [(focusedRowKey)]="selectedTaskId"
                (onSelectionChanged)="onSelectionChanged($event)">
    <dxo-paging [pageSize]="10"></dxo-paging>
    <dxo-pager [showPageSizeSelector]="true"
               [allowedPageSizes]="[5, 10, 20]"
               [showInfo]="true"></dxo-pager>
    <dxo-filter-row [visible]="true"></dxo-filter-row>
    <dxo-header-filter [visible]="true"></dxo-header-filter>
    <dxo-search-panel [visible]="true" placeholder="Search tasks"></dxo-search-panel>

    <dxi-column type="buttons" caption="Actions" [width]="200">
      <dxi-button icon="edit" hint="Edit" [onClick]="onEditClick"></dxi-button>
      <dxi-button icon="trash" hint="Delete" [onClick]="onDeleteClick"></dxi-button>

      <dxi-button icon="link"
                  hint="Assign to Project"
                  [onClick]="onAssignProjectClick"></dxi-button>
    </dxi-column>

    <dxi-column dataField="name" caption="Task Name" [sortOrder]="'asc'"></dxi-column>
    <dxi-column dataField="description" caption="Description"></dxi-column>
    <dxi-column dataField="status"
                caption="Status"
                [cellTemplate]="'statusCellTemplate'"></dxi-column>
    <dxi-column dataField="startTime"
                caption="Start Time"
                dataType="date"
                [customizeText]="formatDate"></dxi-column>
    <dxi-column dataField="endTime"
                caption="End Time"
                dataType="date"
                [customizeText]="formatDate"></dxi-column>
    <dxi-column dataField="customer.name" caption="Customer"></dxi-column>
    <dxi-column dataField="project.name" caption="Project"></dxi-column>
    <dxi-column dataField="car.make" caption="Car Make"></dxi-column>
    <dxi-column dataField="car.model" caption="Car Model"></dxi-column>

    <div *dxTemplate="let cell of 'statusCellTemplate'">
      <span [class]="getStatusClass(cell.value)">{{ cell.value }}</span>
    </div>

    <dxo-toolbar>
      <dxi-item location="before">
        <div class="grid-header">Tasks</div>
      </dxi-item>
      <dxi-item location="before">
        <dx-drop-down-button [items]="filterStatusList"
                             text="Filter by Status"
                             (onItemClick)="filterByStatus($event)"></dx-drop-down-button>
      </dxi-item>
      <dxi-item location="after">
        <dx-button text="Add Task"
                   icon="plus"
                   type="default"
                   stylingMode="contained"
                   (onClick)="addTask()"></dx-button>
      </dxi-item>
      <dxi-item location="after">
        <dx-button text="Refresh"
                   icon="refresh"
                   stylingMode="text"
                   (onClick)="refresh()"></dx-button>
      </dxi-item>
    </dxo-toolbar>
  </dx-data-grid>

  <!-- Task Detail Popup - This is the correct one -->
  <dx-popup [title]="'Task Details - ' + (selectedTask?.name || '')"
            [visible]="isPanelOpened"
            (onHiding)="onOpenedChange($event)"
            [width]="800"
            [height]="700">

    <div *dxTemplate="let data of 'content'">
      <div class="custom-close-button">
        <dx-button icon="close"
                   stylingMode="text"
                   (onClick)="isPanelOpened = false"
                   title="Close">
        </dx-button>
      </div>
      <div *ngIf="selectedTask" class="task-details-container">
        <!-- Basic Task Information -->
        <div class="detail-section">
          <h3>Basic Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Task Name:</label>
              <span>{{selectedTask.name}}</span>
            </div>
            <div class="detail-item">
              <label>Description:</label>
              <span>{{selectedTask.description || 'No description'}}</span>
            </div>
            <div class="detail-item">
              <label>Status:</label>
              <span [class]="getStatusClass(selectedTask.status)">{{selectedTask.status}}</span>
            </div>
            <div class="detail-item">
              <label>Start Time:</label>
              <span>{{formatDate({value: selectedTask.startTime})}}</span>
            </div>
            <div class="detail-item">
              <label>End Time:</label>
              <span>{{formatDate({value: selectedTask.endTime})}}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTask.receivedAt">
              <label>Received At:</label>
              <span>{{formatDate({value: selectedTask.receivedAt})}}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTask.deliveredAt">
              <label>Delivered At:</label>
              <span>{{formatDate({value: selectedTask.deliveredAt})}}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTask.delayReason">
              <label>Delay Reason:</label>
              <span>{{selectedTask.delayReason}}</span>
            </div>
          </div>
        </div>

        <!-- Related Entities -->
        <div class="detail-section">
          <h3>Related Information</h3>
          <div class="detail-grid">
            <div class="detail-item" *ngIf="selectedTask.customer">
              <label>Customer:</label>
              <span>{{selectedTask.customer.name}} ({{selectedTask.customer.phone}}, {{selectedTask.customer.type}})</span>
            </div>
            <div class="detail-item" *ngIf="selectedTask.project">
              <label>Project:</label>
              <span>{{selectedTask.project.name}}</span>
            </div>
            <div class="detail-item" *ngIf="selectedTask.car">
              <label>Car:</label>
              <span>{{selectedTask.car.make}} {{selectedTask.car.model}} ({{selectedTask.car.year}}, {{selectedTask.car.color}})</span>
            </div>
          </div>
        </div>

        <!-- Task Lines -->
        <div class="detail-section" *ngIf="selectedTask.taskLines && selectedTask.taskLines.length > 0">
          <h3>Task Lines</h3>
          <div class="styled-table-container">
            <table class="styled-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Qty</th>
                  <th>Unit Price</th>
                  <th>Total</th>
                  <th>Employee</th>
                  <th>Inventory</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let line of selectedTask.taskLines">
                  <td>{{line.description}}</td>
                  <td class="text-center">{{line.quantity}}</td>
                  <td class="text-right">{{formatCurrency(line.unitPrice)}}</td>
                  <td class="text-right">{{formatCurrency(line.lineTotal)}}</td>
                  <td>{{line.employee?.name || 'N/A'}}</td>
                  <td>{{line.inventory?.name || 'N/A'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="detail-section" *ngIf="!selectedTask.taskLines || selectedTask.taskLines.length === 0">
          <p>No task lines available</p>
        </div>

        <!-- Add Manage Task Lines Button -->
        <div class="detail-section">
          <div class="button-group">
            <dx-button text="Manage Task Lines"
                       icon="edit"
                       type="default"
                       (onClick)="openTaskLinesPopup(selectedTask)"></dx-button>
          </div>
        </div>
      </div>
    </div>
  </dx-popup>

  <!-- Add/Edit Task Popup -->
  <dx-popup [title]="popupTitle"
            [visible]="isAddTaskPopupOpened"
            (onHiding)="onCancelEdit()"
            [width]="500"
            [height]="600">
    <div *dxTemplate="let content of 'content'">
      <div class="form-group">
        <label>Task Name</label>
        <dx-text-box [(value)]="currentTask.name"></dx-text-box>
      </div>
      <div class="form-group">
        <label>Description</label>
        <dx-text-box [(value)]="currentTask.description"></dx-text-box>
      </div>
      <div class="form-group">
        <label>Delay Reason</label>
        <dx-text-box [(value)]="currentTask.delayReason"></dx-text-box>
      </div>
      <div class="form-group">
        <label>Status</label>
        <dx-select-box [items]="statusList"
                       [(value)]="currentTask.status"></dx-select-box>
      </div>
      <div class="form-group">
        <label>Start Time</label>
        <dx-date-box [(value)]="currentTask.startTime"
                     type="datetime"></dx-date-box>
      </div>
      <div class="form-group">
        <label>End Time</label>
        <dx-date-box [(value)]="currentTask.endTime"
                     type="datetime"></dx-date-box>
      </div>
      <div class="button-group">
        <dx-button text="Save"
                   type="success"
                   (onClick)="onSaveTask()"></dx-button>
        <dx-button text="Cancel"
                   type="normal"
                   (onClick)="onCancelEdit()"></dx-button>
      </div>
    </div>
  </dx-popup>

  <!-- Assign to Project Popup -->
  <dx-popup [title]="'Assign Task to Project'"
            [visible]="isAssignProjectPopupOpened"
            (onHiding)="cancelAssignProject()"
            [width]="400"
            [height]="300">
    <div *dxTemplate="let content of 'content'">
      <div *ngIf="taskToAssign">
        <div class="form-group">
          <label>Task: {{taskToAssign.name}}</label>
        </div>
        <div class="form-group">
          <label>Select Project</label>
          <dx-select-box [items]="projects"
                         displayExpr="name"
                         valueExpr="projectId"
                         [(value)]="selectedProjectId"
                         placeholder="Choose a project">
          </dx-select-box>
        </div>
        <div class="button-group">
          <dx-button text="Assign"
                     type="success"
                     (onClick)="assignToProject()">
          </dx-button>
          <dx-button text="Cancel"
                     type="normal"
                     (onClick)="cancelAssignProject()">
          </dx-button>
        </div>
      </div>
    </div>
  </dx-popup>

  <!-- Task Lines Management Popup -->
  <dx-popup [title]="'Manage Task Lines - ' + (selectedTask?.name || '')"
            [visible]="isTaskLinesPopupOpened"
            (onHiding)="closeTaskLinesManagement()"
            [width]="900"
            [height]="600">
    <div *dxTemplate="let content of 'content'">
      <div class="custom-close-button">
        <dx-button icon="close"
                   stylingMode="text"
                   (onClick)="onCancelTaskLineEdit()"
                   title="Close">
        </dx-button>
      </div>

      <dx-button text="Add New Task Line"
                 icon="plus"
                 type="default"
                 stylingMode="contained"
                 (onClick)="addTaskLine()"
                 class="add-button"></dx-button>

      <dx-data-grid [dataSource]="taskLinesDataSource"
                    [showBorders]="true"
                    [allowColumnResizing]="true"
                    [columnAutoWidth]="true">
        <dxo-paging [pageSize]="10"></dxo-paging>
        <dxo-pager [showPageSizeSelector]="true"
                   [allowedPageSizes]="[5, 10, 20]"
                   [showInfo]="true"></dxo-pager>

        <dxi-column type="buttons" caption="Actions" [width]="120">
          <dxi-button icon="edit" hint="Edit" [onClick]="editTaskLine"></dxi-button>
          <dxi-button icon="trash" hint="Delete" [onClick]="deleteTaskLine"></dxi-button>
        </dxi-column>

        <dxi-column dataField="description" caption="Description"></dxi-column>
        <dxi-column dataField="quantity" caption="Qty" dataType="number"></dxi-column>
        <dxi-column dataField="unitPrice" caption="Unit Price" dataType="number" [format]="currencyFormat"></dxi-column>
        <dxi-column dataField="lineTotal" caption="Total" dataType="number" [format]="currencyFormat" [calculateCellValue]="calculateLineTotal"></dxi-column>
        <dxi-column dataField="employee.name" caption="Employee"></dxi-column>
        <dxi-column dataField="inventory.name" caption="Inventory"></dxi-column>
      </dx-data-grid>
    </div>
  </dx-popup>

  <!-- Add/Edit Task Line Popup -->
  <dx-popup [title]="taskLinePopupTitle"
            [visible]="isTaskLineEditPopupOpened"
            (onHiding)="onCancelTaskLineEdit()"
            [width]="500"
            [height]="500">
    <div *dxTemplate="let content of 'content'">
      <div class="form-group">
        <label>Description</label>
        <dx-text-box [(value)]="currentTaskLine.description"></dx-text-box>
      </div>
      <div class="form-group">
        <label>Quantity</label>
        <dx-number-box [(value)]="currentTaskLine.quantity" [min]="1"></dx-number-box>
      </div>
      <div class="form-group">
        <label>Unit Price</label>
        <dx-number-box [(value)]="currentTaskLine.unitPrice" [min]="0" [format]="'$#,##0.##'"></dx-number-box>
      </div>
      <div class="form-group">
        <label>Employee</label>
        <dx-select-box [items]="employees"
                       displayExpr="name"
                       valueExpr="employeeId"
                       [(value)]="currentTaskLine.employeeId"
                       placeholder="Select an employee">
        </dx-select-box>
      </div>
      <div class="form-group">
        <label>Inventory Item</label>
        <dx-select-box [items]="inventories"
                       displayExpr="name"
                       valueExpr="inventoryId"
                       [(value)]="currentTaskLine.inventoryId"
                       placeholder="Select an inventory item">
        </dx-select-box>
      </div>
      <div class="button-group">
        <dx-button text="Save"
                   type="success"
                   (onClick)="onSaveTaskLine()"></dx-button>
        <dx-button text="Cancel"
                   type="normal"
                   (onClick)="onCancelTaskLineEdit()"></dx-button>
      </div>
    </div>
  </dx-popup>
</div>
