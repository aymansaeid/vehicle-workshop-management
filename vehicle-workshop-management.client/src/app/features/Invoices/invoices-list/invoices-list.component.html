<div class="invoices-container">
  <!-- Loading Panel -->
  <dx-load-panel [visible]="isLoading"
                 message="Loading data...">
  </dx-load-panel>

  <!-- Header -->
  <div class="invoices-header">
    <h1>Invoice Management</h1>
    <div class="header-actions">
      <dx-button text="Refresh"
                 icon="refresh"
                 type="normal"
                 stylingMode="outlined"
                 (onClick)="refreshData()">
      </dx-button>
      <dx-button text="Create Invoice"
                 icon="plus"
                 type="default"
                 stylingMode="contained"
                 (onClick)="addInvoice()">
      </dx-button>
    </div>
  </div>

  <!-- Invoices Grid -->
  <dx-data-grid [dataSource]="invoices"
                [showBorders]="true"
                [allowColumnResizing]="true"
                [columnAutoWidth]="true"
                [allowColumnReordering]="true"
                keyExpr="invoiceId">

    <dxo-paging [pageSize]="10"></dxo-paging>
    <dxo-pager [showPageSizeSelector]="true"
               [allowedPageSizes]="[5, 10, 20, 50]"
               [showInfo]="true">
    </dxo-pager>

    <dxo-filter-row [visible]="true"></dxo-filter-row>
    <dxo-search-panel [visible]="true" placeholder="Search invoices..."></dxo-search-panel>
    <dxo-header-filter [visible]="true"></dxo-header-filter>

    <!-- Actions Column -->
    <dxi-column type="buttons" caption="Actions" [width]="280" [fixed]="true">
      <dxi-button icon="edit"
                  hint="Edit Invoice"
                  [onClick]="editInvoice">
      </dxi-button>
      <dxi-button icon="detailslayout"
                  hint="View Details"
                  [onClick]="viewInvoiceDetails">
      </dxi-button>
      <dxi-button icon="exportpdf"
                  hint="Generate PDF"
                  [onClick]="generatePDF">
      </dxi-button>
      <dxi-button icon="trash"
                  hint="Delete Invoice"
                  [onClick]="deleteInvoice">
      </dxi-button>
    </dxi-column>

    <!-- Data Columns -->
    <dxi-column dataField="invoiceId"
                caption="Invoice #"
                dataType="number"
                [width]="120">
    </dxi-column>

    <dxi-column dataField="customerId"
                caption="Customer"
                [calculateCellValue]="getCustomerName"
                [width]="200">
    </dxi-column>

    <dxi-column dataField="dateIssued"
                caption="Date Issued"
                dataType="date"
                [format]="'dd/MM/yyyy'"
                [width]="120">
    </dxi-column>

    <dxi-column dataField="dueDate"
                caption="Due Date"
                dataType="date"
                [format]="'dd/MM/yyyy'"
                [width]="120">
    </dxi-column>

    <dxi-column dataField="totalAmount"
                caption="Total Amount"
                dataType="number"
                [format]="'currency'"
                [width]="140">
    </dxi-column>

    <dxi-column dataField="status"
                caption="Status"
                [cellTemplate]="'statusCellTemplate'"
                [width]="120">
    </dxi-column>

    <dxi-column dataField="notes"
                caption="Notes"
                [visible]="false">
    </dxi-column>

    <!-- Status Template -->
    <div *dxTemplate="let cell of 'statusCellTemplate'">
      <span [class]="getStatusClass(cell.value)">{{ cell.value }}</span>
    </div>
  </dx-data-grid>

  <!-- Add/Edit Invoice Popup -->
  <dx-popup [title]="popupTitle"
            [visible]="isInvoicePopupOpened"
            (onHiding)="onCancelInvoice()"
            [width]="600"
            [height]="550"
            [showCloseButton]="true"
            [dragEnabled]="false"
            [resizeEnabled]="false">

    <div *dxTemplate="let content of 'content'">
      <div class="form-container">
        <div class="form-group">
          <label>Customer *</label>
          <dx-select-box [items]="customers"
                         displayExpr="name"
                         valueExpr="customerId"
                         [(value)]="currentInvoice.customerId"
                         placeholder="Select customer"
                         [searchEnabled]="true">
          </dx-select-box>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date Issued *</label>
            <dx-date-box [(value)]="currentInvoice.dateIssued"
                         type="date"
                         [max]="currentInvoice.dueDate">
            </dx-date-box>
          </div>

          <div class="form-group">
            <label>Due Date *</label>
            <dx-date-box [(value)]="currentInvoice.dueDate"
                         type="date"
                         [min]="currentInvoice.dateIssued">
            </dx-date-box>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Total Amount</label>
            <dx-number-box [(value)]="currentInvoice.totalAmount"
                           [min]="0"
                           [format]="'currency'"
                           placeholder="Enter total amount"
                           [readOnly]="true">
            </dx-number-box>
            <small class="form-text">Total will be calculated from invoice lines</small>
          </div>

          <div class="form-group">
            <label>Status *</label>
            <dx-select-box [items]="statusOptions"
                           [(value)]="currentInvoice.status"
                           placeholder="Select status">
            </dx-select-box>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <dx-text-area [(value)]="currentInvoice.notes"
                        placeholder="Additional notes"
                        [height]="80">
          </dx-text-area>
        </div>

        <div class="button-group">
          <dx-button text="Save"
                     type="success"
                     stylingMode="contained"
                     (onClick)="onSaveInvoice()">
          </dx-button>
          <dx-button text="Cancel"
                     type="normal"
                     stylingMode="outlined"
                     (onClick)="onCancelInvoice()">
          </dx-button>
        </div>
      </div>
    </div>
  </dx-popup>

  <!-- Invoice Details Popup -->
  <dx-popup [title]="'Invoice Details - #' + (selectedInvoice?.invoiceId || '')"
            [visible]="isInvoiceDetailPopupOpened"
            (onHiding)="onCancelInvoiceDetail()"
            [width]="900"
            [height]="700"
            [showCloseButton]="true"
            [dragEnabled]="false"
            [resizeEnabled]="true">

    <div *dxTemplate="let content of 'content'">
      <!-- Invoice Header Info -->
      <div class="invoice-detail-header" *ngIf="selectedInvoice">
        <div class="invoice-info">
          <h3>{{getCustomerName(selectedInvoice.customerId)}}</h3>
          <div class="invoice-meta">
            <span>Total: {{formatCurrency(selectedInvoice.totalAmount)}}</span>
            <span [class]="getStatusClass(selectedInvoice.status)">{{selectedInvoice.status}}</span>
            <span>Due: {{formatDate(selectedInvoice.dueDate)}}</span>
          </div>
          <p *ngIf="selectedInvoice.notes" class="invoice-notes">{{selectedInvoice.notes}}</p>
        </div>
        <div class="invoice-actions">
          <dx-button text="Add Line"
                     icon="plus"
                     type="default"
                     stylingMode="contained"
                     (onClick)="addInvoiceLine()">
          </dx-button>
          <dx-button text="Edit Invoice"
                     icon="edit"
                     type="normal"
                     stylingMode="outlined"
                     (onClick)="editInvoice(selectedInvoice)">
          </dx-button>
        </div>
      </div>

      <!-- Invoice Lines Grid -->
      <div class="invoice-lines-section">
        <h4>Invoice Lines</h4>
        <dx-data-grid [dataSource]="invoiceLines"
                      [showBorders]="true"
                      [allowColumnResizing]="true"
                      [columnAutoWidth]="true"
                      keyExpr="lineId">

          <dxo-paging [pageSize]="10"></dxo-paging>

          <!-- Actions Column -->
          <dxi-column type="buttons" caption="Actions" [width]="150">
            <dxi-button icon="edit"
                        hint="Edit Line"
                        [onClick]="editInvoiceLine">
            </dxi-button>
            <dxi-button icon="trash"
                        hint="Delete Line"
                        [onClick]="deleteInvoiceLine">
            </dxi-button>
          </dxi-column>

          <!-- Data Columns -->
          <dxi-column dataField="description" caption="Description"></dxi-column>
          <dxi-column dataField="quantity"
                      caption="Qty"
                      dataType="number"
                      [width]="80">
          </dxi-column>
          <dxi-column dataField="unitPrice"
                      caption="Unit Price"
                      dataType="number"
                      [format]="'currency'"
                      [width]="120">
          </dxi-column>
          <dxi-column dataField="lineTotal"
                      caption="Line Total"
                      dataType="number"
                      [format]="'currency'"
                      [width]="120">
          </dxi-column>
        </dx-data-grid>
      </div>

      <div class="button-group">
        <dx-button text="Close"
                   type="normal"
                   stylingMode="outlined"
                   (onClick)="onCancelInvoiceDetail()">
        </dx-button>
      </div>
    </div>
  </dx-popup>

  <!-- Add/Edit Invoice Line Popup -->
  <dx-popup [title]="linePopupTitle"
            [visible]="isLinePopupOpened"
            (onHiding)="onCancelLine()"
            [width]="550"
            [height]="500"
            [showCloseButton]="true"
            [dragEnabled]="false"
            [resizeEnabled]="false">

    <div *dxTemplate="let content of 'content'">
      <div class="form-container">
        <div class="form-group">
          <label>Description *</label>
          <dx-text-box [(value)]="currentLine.description"
                       placeholder="Enter line description">
          </dx-text-box>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Task Line</label>
            <dx-select-box [items]="taskLines"
                           displayExpr="description"
                           valueExpr="taskLineId"
                           [(value)]="currentLine.taskLineId"
                           (onValueChanged)="onTaskLineChanged($event.value)"
                           placeholder="Select task line (optional)"
                           [searchEnabled]="true">
            </dx-select-box>
          </div>

          <div class="form-group">
            <label>Inventory Item</label>
            <dx-select-box [items]="inventoryItems"
                           displayExpr="name"
                           valueExpr="inventoryId"
                           [(value)]="currentLine.inventoryId"
                           (onValueChanged)="onInventoryItemChanged($event.value)"
                           placeholder="Select inventory item (optional)"
                           [searchEnabled]="true">
            </dx-select-box>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Quantity *</label>
            <dx-number-box [(value)]="currentLine.quantity"
                           [min]="0.01"
                           [step]="1"
                           (onValueChanged)="calculateLineTotal()"
                           placeholder="Enter quantity">
            </dx-number-box>
          </div>

          <div class="form-group">
            <label>Unit Price *</label>
            <dx-number-box [(value)]="currentLine.unitPrice"
                           [min]="0"
                           [format]="'currency'"
                           (onValueChanged)="calculateLineTotal()"
                           placeholder="Enter unit price">
            </dx-number-box>
          </div>
        </div>

        <div class="form-group">
          <label>Line Total</label>
          <dx-number-box [(value)]="currentLine.lineTotal"
                         [format]="'currency'"
                         [readOnly]="true"
                         placeholder="Calculated automatically">
          </dx-number-box>
        </div>

        <div class="button-group">
          <dx-button text="Save"
                     type="success"
                     stylingMode="contained"
                     (onClick)="onSaveLine()">
          </dx-button>
          <dx-button text="Cancel"
                     type="normal"
                     stylingMode="outlined"
                     (onClick)="onCancelLine()">
          </dx-button>
        </div>
      </div>
    </div>
  </dx-popup>
</div>
